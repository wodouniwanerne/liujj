// Generated by CoffeeScript 1.9.3
(function() {
  var WechatMsg, _, crypto, wxCrypto, xml2js;

  _ = require('lodash');

  wxCrypto = require('wechat-crypto');

  xml2js = require('xml2js');

  crypto = require('crypto');

  module.exports = WechatMsg = (function() {
    function WechatMsg(token, aesKey, appId) {
      this.wx = new wxCrypto(token, aesKey, appId);
    }

    WechatMsg.prototype.valida = function(timestamp, nonce) {
      var arr, shasum;
      shasum = crypto.createHash('sha1');
      arr = [this.wx.token, timestamp, nonce].sort();
      shasum.update(arr.join(''));
      return shasum.digest('hex');
    };

    WechatMsg.prototype.decryptMsg = function(msg_signature, timestamp, nonce, xml, callback) {
      var wx;
      wx = this.wx;
      return xml2js.parseString(xml, function(err, result) {
        var deMsg, enMsg, sign;
        enMsg = result.xml.Encrypt[0];
        sign = wx.getSignature(timestamp, nonce, enMsg);
        if (sign !== msg_signature) {
          return callback(Error('sign err'));
        }
        deMsg = wx.decrypt(enMsg);
        if (deMsg.id !== wx.id) {
          return callback(Error('appid err'));
        }
        return xml2js.parseString(deMsg.message, function(err, result) {
          var kv;
          kv = {};
          _.each(result.xml, function(v, k) {
            return kv[k] = v[0];
          });
          return callback(null, kv);
        });
      });
    };

    WechatMsg.prototype.encryptMsg = function(timestamp, nonce, msg) {
      var enMsg, sign, xml;
      if (_.isString(msg)) {
        xml = msg;
      } else {
        xml = '<xml>';
        _.each(msg, function(v, k) {
          if (_.isString(v)) {
            v = "<![CDATA[" + v + "]]>";
          }
          return xml += "<" + k + ">" + v + "</" + k + ">";
        });
        xml += '</xml>';
      }
      enMsg = this.wx.encrypt(xml);
      sign = this.wx.getSignature(timestamp, nonce, enMsg);
      return "<xml> <Encrypt><![CDATA[" + enMsg + "]]></Encrypt> <MsgSignature><![CDATA[" + sign + "]]></MsgSignature> <TimeStamp>" + timestamp + "</TimeStamp> <Nonce><![CDATA[" + nonce + "]]></Nonce> </xml>";
    };

    return WechatMsg;

  })();

}).call(this);
